(function() {
	// Load plugin specific language pack
	//tinymce.PluginManager.requireLangPack('example');

	tinymce.create('tinymce.plugins.MaxChars', {
		/**
		 * Initializes the plugin, this will be executed after the plugin has been created.
		 * This call is done before the editor instance has finished it's initialization so use the onInit event
		 * of the editor instance to intercept that event.
		 *
		 * @param {tinymce.Editor} ed Editor instance that the plugin is initialized in.
		 * @param {string} url Absolute URL to where the plugin is located.
		 */		 
		init : function(ed, url) {
			var t=this;
			t.editor = ed;
		
			ed.on('keyup', function(t) {
				checkMaxChars(ed);
			});
			
			ed.on('change', function(t) {
				checkMaxChars(ed);
			});
			
			ed.on('setcontent', function(t) {
				checkMaxChars(ed);
			});
		},
		
	});

	function checkMaxChars(ed) {
			var mc = parseInt(ed.getParam("max_chars"));//how many characters (int)
			var no_spaces = ed.getParam("max_chars_nospaces");//count spaces or not (1 or empty)
			var lb = ed.getParam("max_chars_indicator");//ID of div, span container or input
			var mn = ed.getParam("max_chars_text","");//message before the number of characters
			var mm = ed.getParam("max_chars_maxText","");//message when max chars are reached
			
			var characters 			= ed.getParam("characters","");
			var characters_left		= ed.getParam("characters_left","");
			var maximum_characters 	= ed.getParam("maximum_characters","");
			
			var cnt_cur = "";//current text content
        	var cnt_html = "";//current html content
        
			if (tinymce.isIE){
				cnt_cur = ed.getBody().innerText.replace(/<\/?[^>]+(>|$)/g,"").replace(/&nbsp;/gi,"");
				cnt_html =  ed.getBody().innerHTML;
			}else{
				cnt_cur = ed.getBody().textContent.replace(/<\/?[^>]+(>|$)/g,"").replace(/&nbsp;/gi,"");
				cnt_html =  ed.getBody().innerHTML;
			} 	
			
			var cnt = cnt_cur.replace(/<\/?[^>]+(>|$)/g, "");
			//check for no spaces count
			if(no_spaces==1)
				cnt = cnt.replace(/\s/g, "");
		
			if( mc > 0 && cnt.length >= 0 && mc<cnt.length && this._MCtext != cnt_cur ) {				
				ed.setContent(this._MCtext);				
			}
			else
				this._MCtext = cnt_html;
			
			//check for indicator
			if(lb = document.getElementById(lb)) {
				var lb_val = (lb.tagName.toLowerCase() == "input") ? lb.value : parseInt(lb.innerHTML);	
				
				if(lb_val != null) {				
					if(lb.tagName.toLowerCase()=='input'){
						if (mc - cnt.length < 0) {
							if(mm!="") 
					    		lb.value = mm;
						}else{ 
							lb.value = cnt.length + " " + characters + " |" + (mc - cnt.length) + " " + characters_left + " |"+ mc + " " + maximum_characters;
						}
					}
					else{
						if (mc - cnt.length < 0) {
							if(mm!="") 
								lb.innerHTML =  mm;
						}
						else{
							lb.innerHTML = cnt.length + " " + characters + " |" + (mc - cnt.length) + " " + characters_left + " |"+ mc + " " + maximum_characters;
						}				  
				    }
				}
			}
			return 1;
		}
	
	// Register plugin
	tinymce.PluginManager.add('maxchars', tinymce.plugins.MaxChars);
})();